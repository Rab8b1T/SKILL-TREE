<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password — Skill Tree</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { display:flex; align-items:center; justify-content:center; min-height:100vh; }
    </style>
</head>
<body>
    <div class="auth-gate-card" style="width:100%;max-width:400px">
        <div class="auth-gate-brand">
            <div class="auth-gate-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <h1>Skill Tree</h1>
            <p class="auth-gate-tagline" id="page-subtitle">Set a new password</p>
        </div>

        <div id="form-area">
            <form id="reset-form" class="auth-form">
                <input type="password" id="new-password" placeholder="New password (min 4 characters)" required minlength="4" autocomplete="new-password">
                <input type="password" id="confirm-password" placeholder="Confirm new password" required minlength="4" autocomplete="new-password">
                <button type="submit" class="btn btn-primary auth-submit">Set new password</button>
            </form>
        </div>

        <div id="done-area" style="display:none;text-align:center;padding:1rem 0">
            <p style="color:var(--accent-success);font-size:1.1rem;margin-bottom:1rem">✔ Password updated!</p>
            <a href="/" class="btn btn-primary" style="display:inline-block;text-decoration:none">Go to login</a>
        </div>

        <div id="invalid-area" style="display:none;text-align:center;padding:1rem 0">
            <p style="color:var(--accent-danger);margin-bottom:1rem" id="invalid-msg">This reset link is invalid or has expired.</p>
            <a href="/" class="btn btn-secondary" style="display:inline-block;text-decoration:none">Back to login</a>
        </div>
    </div>

    <script>
    (function () {
        var token = new URLSearchParams(window.location.search).get('token');
        if (!token) {
            document.getElementById('form-area').style.display = 'none';
            document.getElementById('invalid-area').style.display = 'block';
        }

        var toastTimer;
        function toast(msg, type) {
            var old = document.getElementById('rp-toast');
            if (old) old.remove();
            var t = document.createElement('div');
            t.id = 'rp-toast';
            t.style.cssText = 'position:fixed;top:28px;left:50%;transform:translateX(-50%);z-index:99999;display:flex;align-items:center;gap:10px;padding:14px 22px;border-radius:10px;font-family:inherit;font-size:14px;font-weight:500;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,.55);max-width:400px;line-height:1.4;opacity:0;transition:opacity .25s ease;' +
                (type === 'success' ? 'background:linear-gradient(135deg,#10b981,#059669)' : 'background:linear-gradient(135deg,#ef4444,#dc2626)');
            t.innerHTML = '<span style="font-size:16px">' + (type === 'success' ? '✔' : '⚠') + '</span><span>' + msg + '</span>';
            document.body.appendChild(t);
            requestAnimationFrame(function(){ requestAnimationFrame(function(){ t.style.opacity='1'; }); });
            clearTimeout(toastTimer);
            toastTimer = setTimeout(function(){ t.style.opacity='0'; setTimeout(function(){ t.remove(); },300); }, 4500);
        }

        document.getElementById('reset-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            var newPass     = document.getElementById('new-password').value;
            var confirmPass = document.getElementById('confirm-password').value;
            var btn         = this.querySelector('button[type=submit]');

            if (newPass.length < 4) { toast('Password must be at least 4 characters.', 'error'); return; }
            if (newPass !== confirmPass) { toast('Passwords do not match.', 'error'); return; }

            btn.disabled = true; btn.textContent = 'Saving…';
            try {
                var res  = await fetch('/api/auth/reset-confirm', {
                    method : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body   : JSON.stringify({ token: token, newPassword: newPass }),
                });
                var data = {};
                try { data = await res.json(); } catch (_) {}

                if (res.ok) {
                    document.getElementById('form-area').style.display = 'none';
                    document.getElementById('done-area').style.display = 'block';
                } else if (res.status === 400) {
                    document.getElementById('form-area').style.display = 'none';
                    document.getElementById('invalid-msg').textContent = data.error || 'Reset link invalid or expired.';
                    document.getElementById('invalid-area').style.display = 'block';
                } else {
                    toast(data.error || 'Something went wrong. Try again.', 'error');
                    btn.disabled = false; btn.textContent = 'Set new password';
                }
            } catch (err) {
                toast('Network error: ' + err.message, 'error');
                btn.disabled = false; btn.textContent = 'Set new password';
            }
        });
    })();
    </script>
</body>
</html>
